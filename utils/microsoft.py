import datetime
import urllib.request
from urllib.error import URLError
import os

BULLETIN_URL = 'http://download.microsoft.com/download/6/7/3/673E4349-1CA5-40B9-8879-095C72D5B49D/BulletinSearch.xlsx'

class Bulletin():
    """
        Official Bulletin from Microsoft
    """
    
    @staticmethod
    def download():
        """
            Download official document
        """
        __filename = f"{datetime.datetime.now().strftime('%Y-%m-%d')}-mssb"
        __xlsfile = f"{__filename}.xls"
        #TODO: Reimplements with requests module
        __opener = urllib.request.build_opener()
        __opener.addheaders = [
            ('User-agent', 'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36')
        ]
        try:
            if not __xlsfile in os.listdir(os.getcwd()):
                __response = __opener.open(BULLETIN_URL)
                __bulletinData = __response.read()

                print(f"{Fore.YELLOW}[#] Writing to file {__xlsfile}")

                with open(__xlsfile, "wb") as f:
                    f.write(__bulletinData)
            else:
                print(f"{Fore.GREEN}[*] New bulletin file version already downloaded {__xlsfile}")
        except URLError:
            print(f"{Fore.RED}[!] Error getting ms from {BULLETIN_URL}")
            exit(1)